name: Nova Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  unit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - suite: tensor
            path: tests/unit/tensor
          - suite: activations
            path: tests/unit/activations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install system build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build curl \
            python3-dev pybind11-dev \
            libopenblas-dev liblapack-dev \
            libeigen3-dev libgtest-dev \
            libsleef-dev

      # This action installs Poetry and exports it on PATH for later steps
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Install Python deps with Poetry
        run: poetry install --no-interaction --no-ansi

      - name: Show tool versions
        run: |
          python -V
          poetry --version
          poetry run python -V
          cmake --version
          ninja --version

      - name: "CMake configure (preset: dev) with Poetry's Python"
        env:
          PY: ${{ github.workspace }}/.venv/bin/python
        run: |
          cmake --preset dev \
            -DPython3_EXECUTABLE="$PY" \
            -DPython_EXECUTABLE="$PY"

      - name: "CMake build (preset: dev)"
        run: cmake --build --preset dev -j"$(nproc)"

      - name: Export PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=${{ github.workspace }}/nova/src/backend/core/clib:${{ github.workspace }}" >> $GITHUB_ENV

      - name: Run ${{ matrix.suite }} unit tests
        run: |
          poetry run pytest -v ${{ matrix.path }}
